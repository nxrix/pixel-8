<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Pixel-8 Image To String</title>
</head>
<body>
  <h1>Img2Str</h1>
  <input type="file" id="input">
  <br>
  <br>
  <img id="output">
  <br>
  <canvas id="canvas" hidden></canvas>
  <button id="copy">Copy</button>
</body>
<script>

const palette = [
  [0x1d,0x18,0x26],
  [0x8b,0x7f,0xb0],
  [0xc3,0xbe,0xe5],
  [0xff,0xe8,0xe9],
  [0x65,0x26,0x4e],
  [0xa0,0x1a,0x3d],
  [0xde,0x1b,0x45],
  [0xf2,0x63,0x7b],
  [0x8b,0x3f,0x39],
  [0xbb,0x45,0x31],
  [0xef,0x5d,0x0e],
  [0xff,0x95,0x00],
  [0x00,0xa0,0x3d],
  [0x12,0xd5,0x00],
  [0xb4,0xd8,0x00],
  [0xff,0xc3,0x1f],
  [0x00,0x6e,0x69],
  [0x00,0xae,0x85],
  [0x00,0xda,0xa7],
  [0x4f,0xd6,0xff],
  [0x2b,0x27,0x54],
  [0x3c,0x51,0xaf],
  [0x18,0x88,0xde],
  [0x00,0xa9,0xe1],
  [0x59,0x3c,0x97],
  [0x89,0x44,0xcf],
  [0xb4,0x4a,0xff],
  [0xe9,0x59,0xff],
  [0xe7,0x87,0x6d],
  [0xff,0xba,0x8c],
  [0xff,0xef,0x5c],
  [0xff,0x9c,0xde]
];

const bayer4x4 = [
  [ 0, 8, 2, 10],
  [12, 4, 14, 6],
  [ 3, 11, 1, 9],
  [15, 7, 13, 5]
];

const rgb = ([r,g,b]) => {
  let m = Infinity;
  let n = -1;
  for (let i = 0; i < palette.length; i++) {
    const c = palette[i];
    const d = Math.sqrt(
      (r - c[0]) ** 2 + 
      (g - c[1]) ** 2 +
      (b - c[2]) ** 2
    );
    if (d<m) {
      m = d;
      n = i;
    }
  }
  return n;
}

const ctx = canvas.getContext("2d");

const get_data = (img) => {
  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img,0,0);
  const imageData = ctx.getImageData(0,0,img.width,img.height);
  const data = imageData.data;
  let result = "";
  for (let i = 0; i < data.length; i += 4) {
    const p = i/4;
    const x = p % canvas.width;
    const y = Math.floor(p / canvas.width);
    const b = bayer4x4[x%4][y%4]/32;
    /*const color = [
      Math.floor(data[i  ]/2+b)*2,
      Math.floor(data[i+1]/2+b)*2,
      Math.floor(data[i+2]/2+b)*2
    ];*/
    const n = rgb([data[i],data[i+1],data[i+2]]);
    if (data[i+3]>0) {
      const c = palette[n];
      data[i  ] = c[0];
      data[i+1] = c[1];
      data[i+2] = c[2];
      data[i+3] =  255;
      result += n.toString(33);
    } else {
      result += "w";
    }
  }
  ctx.putImageData(imageData,0,0);
  output.src = canvas.toDataURL();
  return result;
}

const copy_text = (str) => {
  const el = document.createElement("textarea");
  el.value = str;
  document.body.appendChild(el);
  el.select();
  document.execCommand("copy");
  document.body.removeChild(el);
  el.remove();
}

input.addEventListener("change",()=>{
  const file = input.files[0];
  const img = new Image();
  img.onload = () => {
    const d = get_data(img);
    copy.onclick = () => {
      copy_text(`${img.width},${img.height},${d}`);
    }
  };
  img.src = URL.createObjectURL(file);
});

</script>
</html>